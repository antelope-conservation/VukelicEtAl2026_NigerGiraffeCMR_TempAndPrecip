---
title: "GOF_MSMR_giarffe_temp"
author: "Mara Vukelić"
date: "2025-09-16"
output: html_document
---

Creating and exporting saturated model for the goodness of fit testing in program MARK

```{r}

rm(list = ls())

```


Loading libraries and encounter histories data - GIRAFFE DATA
```{r}

library(tidyverse)
library(RMark)
library(here)

eh <- read.csv('./data/WA_giraffe_encounter_histories.csv', sep = ";", 
               colClasses = c("character", "character"))

```


Data processing and making design data list
```{r}

## processing the encounter history
giraffe_processed <- process.data(eh, model = "Multistrata", group = 'SEX', begin.time = 2005)

## create design data list 
giraffe_ddl <- make.design.data(giraffe_processed, parameters = list(S = list(pim.type = "time"), p = list(pim.type = "time"), Psi = list(pim.type = "constant")))

```


Fixing Psi (transition parameter) for parameters that can not transition from one to another:
```{r}


giraffe_ddl$Psi$fix <- NA

## juvenile to adult
giraffe_ddl$Psi$fix[giraffe_ddl$Psi$stratum == "1" & giraffe_ddl$Psi$tostratum == "3"] <- 0

## subadult to juvenile
giraffe_ddl$Psi$fix[giraffe_ddl$Psi$stratum == "2" & giraffe_ddl$Psi$tostratum == "1"] <- 0

## adult to juvenile
giraffe_ddl$Psi$fix[giraffe_ddl$Psi$stratum == "3" & giraffe_ddl$Psi$tostratum == "1"] <- 0

## adult to subadult
giraffe_ddl$Psi$fix[giraffe_ddl$Psi$stratum == "3" & giraffe_ddl$Psi$tostratum == "2"] <- 0


```


INTRODUCING TEMPERATURE DATA
```{r}

library(dplyr)
library(ggplot2)
library(lubridate)

# Load the temperature data
TMaxDaily <- read.csv('./data/DailyMaxTemp_GZ_simple_05_18.csv')

# Ensure date column is in proper Date format
TMaxDaily <- TMaxDaily %>%
  mutate(date = as.Date(date),
         year = year(date),
         month = month(date))


```


Extracting the needed temperature covariate and merging with giraffe ddl
```{r}


# Days with max temp ≥ 35°C, excluding Dec/Jan/Feb
hot_35_no_djf <- TMaxDaily %>%
  filter(max_temp_C >= 35, !month %in% c(12, 1, 2)) %>%
  count(year, name = "hot_35_no_djf")


# merge
giraffe_ddl$S <- giraffe_ddl$S %>%
  mutate(time = as.numeric(as.character(time))) %>%
  left_join(hot_35_no_djf, by = c("time" = "year")) %>%
  mutate(time = as.factor(time))  # restore to factor for modeling


# Calculate anomalies (z-scores)

### We are calling this new covariate N_hot_days !!!

hot_35_no_djf <- hot_35_no_djf %>%
  mutate(
    N_hot_days = scale(hot_35_no_djf)[, 1]
  )

# Merge with giraffe_ddl
giraffe_ddl$S <- giraffe_ddl$S %>%
  mutate(time = as.numeric(as.character(time))) %>%  # Ensure numeric time for joining
  left_join(hot_35_no_djf %>% select(year, N_hot_days),
            by = c("time" = "year")) %>%
  mutate(time = as.factor(time))  # Restore factor structure


```


Building saturated model
```{r}

## define parameters

S.time <- list(formula = ~SEX*stratum+N_hot_days)
p.time <- list(formula = ~SEX+stratum*time)
Psi <- list(formula = ~ -1 + stratum:tostratum) 


## make model
model_saturated <- make.mark.model(data = giraffe_processed, 
                           ddl = giraffe_ddl,
                           parameters = list(S = S.time,
                                             p = p.time,
                                             Psi = Psi),
                           model.name = "Giraffe_saturated",
                           useddl = TRUE)

## run the model
model_saturated <- run.mark.model(model = model_saturated,
                                 filename = "testmark",
                                 prefix = "testmark")



```


Exporting saturated model to program MARK for the goodness of fit testing
```{r}

export.MARK(x = giraffe_processed, project.name = 'giraffe_temperature_MS_GOF', 
            model = model_saturated, replace = TRUE)

```